# 인기 상품 조회 고도화

## 1. 용어 정의

| 항목              | 설명                            |
|-----------------|-------------------------------|
| 인기 상품 조회        | 주문이 완료된 상품의 판매 수량을 기준으로, 가장 많이 팔린 순서(내림차순)로 상품 목록을 조회 |
| 일간 인기 상품 조회     | 어제 기준 일간 인기 상품을 조회 (오늘은 제외)   |
| 최근 3일의 인기 상품 조회 | 오늘을 제외한 과거 3일 동안의 인기 상품을 조회   |

## 2. AS-IS

![as-is인기상품조회.png](/docs/image/as-is인기상품조회.png)

> 인기 상품 조회 시마다 주문 관련 DB 테이블에서 주문 완료된 상품의 판매량 집계 및 정렬 쿼리를 실행하는 것은 비용이 크기 때문에<BR>
> 매일 스케줄러를 통해 통계 테이블에 데이터를 누적하고 이를 기반으로 최근 3일간의 인기 상품 데이터를 생성한 후,<br> 
> 해당 데이터를 캐싱하여 효율적인 조회가 가능하도록 설계하였다.

### [사전 작업] - 스케쥴러
스케쥴러는 매일 자정에 실행된다
1. 주문 관련 db 테이블에서 어제 기준 주문 완료된 상품들의 판매량 집계를 조회한다 
2. `1.에서 조회한 데이터`를 daily_product_sale 테이블에 저장한다
3. daily_product_sale 테이블에서 최근 3일간의 판매 데이터를 합산하여, 판매량 기준 상위 5개 상품을 조회한다
4. `3.에서 조회한 데이터`를 best_selling_product 테이블에 저장한다
5. best_selling_product 테이블의 데이터를 레디스에 캐시로 저장한다

### [최근 3일의 인기 상품 api 요청]
인기 상품 api 요청 시, 레디스에서 캐시를 읽어서 데이터를 반환한다

## 3. 고민
### 문제 상황
- 일별 집계, 최근 3일간의 집계가 DB에서 실행되므로 **집계 쿼리에 의한 부하** 발생 위험이 존재한다
<br>`이를 해결하기 위해, **주문 완료 시점에 Redis에 일별 판매 상품 데이터를 누적**하는 방향을 고려하였다`

### 1차 설계
- db를 사용하지 않고 Redis 기반으로 일별 상품 판매 데이터를 집계하여 최근 3일간의 인기 상품을 조회하는 구조
- 각 날짜별 데이터를 Redis에 저장하여 사용
    - `product_sales:20240514`
    - `product_sales:20240515`
    - `product_sales:20240516`
- 최근 3일간의 상품 판매 데이터를 redis에서 조회하여, 하나의 ZSet(`product_sales:20240514-20240516`)에 합산하여 랭킹을 구성하였다

### 1차 설계 문제점
ZSet에 모든 데이터를 합산하여 랭킹을 구성하니 **Redis 메모리 사용량 증가** 및 **부하 우려**가 고민된다

### 해결 방안
`Redis에는 일별 상품 판매 집계만 저장하도록 결정하였다`
- **주문 완료 시마다 Redis에 일별 상품 판매량을 누적 저장**.
- **일별 스케줄러는 Redis에서 누적된 데이터를 읽어 daily_product_sale에 저장**하는 방식으로 전환.
  - 일별 상품 판매 집계를 주문 관련 테이블에서 실행할 필요가 없어졌다 

## 4. to-be

![to-be인기상품조회.png](/docs/image/to-be인기상품조회.png)
### [사전 작업 1] - 주문 요청 시
- 일별 상품 판매 집계를 스케쥴러에서 하지 않고 주문 완료 시, 레디스의 zset에 누적 합산하도록 변경하였다
- 해당 데이터의 ttl은 25h로 둬서 하루 뒤 자동 소멸하게 설정한다

### [사전 작업 2] - 스케쥴러
- 일별 상품 판매 집계를 레디스에 저장된 데이터를 조회하여 daily_product_sale 테이블에 저장한다
- 나머지 스케쥴러 동작은 as-is와 동일하다

### [일별 인기 상품 api 요청]
일별 상품 판매 집계를 Redis ZSet에 저장하고, 이를 활용하는 일별 인기 상품 API를 새롭게 추가하였다.<br>
API는 Redis에서 상품 ID를 조회한 후, 해당 ID들을 기반으로 상품 테이블과 조인하여 상세 정보를 조회하는 방식으로 동작한다.
