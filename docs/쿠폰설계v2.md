# 쿠폰 발급 카프카 적용 보고서

# 1. 개요
> 쿠폰 발급 기능 개발 과정에서 동시성 이슈를 해결하기 위해 다양한 접근을 시도했습니다.<br>
> 처음에는 `쿠폰의 재고에 데이터베이스의 비관적 락을 사용`하여 동시성 이슈를 해결하고자 하였으나<br>
> 락으로 인해 커넥션 대기 시간이 길어지고 커넥션이 끊기는 문제가 우려가 되었습니다<br>
> 이에 `커넥션을 보호하기 위해 분산락을 적용`했지만, 락 자체가 성능 저하를 유발하는 근본적인 문제는 해결되지 않았습니다.<br>
> 락을 사용하지 않는 방향으로 접근하기 위해 `큐잉 기반 순차 처리 방식을 고려하였고, `Redis의 ZSET을 이용해 선착순 쿠폰 발급 기능을 구현`했습니다.<br>
> 그러나 이 방식 역시 설계 상의 고민이 여전히 존재했고, 이를 해결하고자 Kafka를 도입하여 보다 안정적이고 확장 가능한 구조로 개선하고자 합니다.

# 2. AS-IS - Redis를 이용한 쿠폰 발급
![쿠폰카프카before.png](/docs/image/쿠폰카프카before.png)

> `쿠폰의 요청을 받는 곳(Producer)와 쿠폰 발급을 처리(Consumer)를 분리하고 Consumer가 역할을 하는 스케쥴러가 1분 주기로 실행되도록 구현하였다`

### Producer
사용자가 쿠폰 발급을 요청하면, 해당 쿠폰 ID와 요청한 사용자 ID를 Redis에 저장한다

### Consumer
1분 주기로 스케줄러가 실행되며, 다음과 같은 작업을 수행한다
1. Redis에서 발급 요청이 등록된 쿠폰 ID 목록을 조회한다
2. 조회된 쿠폰 ID 목록을 순회하며 각 쿠폰에 대해 다음을 처리한다
    - 해당 쿠폰의 재고 수량을 조회한다
    - 재고 수량만큼 발급 요청 유저 ID 목록을 조회하고 제거(pop) 한다
    - 조회된 유저 ID 목록을 대상으로 쿠폰 발급을 수행한다
    - 쿠폰 발급이 완료되면, Redis에서 해당 쿠폰 ID 및 유저 ID 목록을 제거한다

## 2-1. Kafka 기반 쿠폰 발급 설계 전환 이유

### 쿠폰 ID가 다르더라도 모든 발급 요청이 순차적으로 처리되어 불필요한 대기 시간이 발생
- Kafka를 사용하여 쿠폰 ID별로 병렬 처리가 이루어지는 구조가 변경 가능하다

### 발급 요청이 집중될 경우 데이터베이스에 과부하 발생 우려
- Kafka 컨슈머 수를 조절하여 데이터베이스 부하를 관리하며 안정적으로 발급할 수 있도록 설계가 가능하다

### 쿠폰 발급 정보를 Redis와 DB 양쪽에서 관리하여 유지보수 비용 증가
- 특히 Redis는 롤백 기능이 없어 관리가 어렵기 때문에 가능하면 Redis 사용을 최소화하는 방향이 좋다
- Kafka는 큐잉 시스템으로 순차 처리 보장이 가능하므로 Redis Zset 없이 동시성 이슈 없이 쿠폰 발급이 가능하다
- 다만, 쿠폰 재고가 없는 경우 불필요한 요청이 데이터베이스로 전달되는 것을 방지하기 위해<br>발급 가능한 쿠폰 ID 목록만 Redis에서 관리하는 방식을 채택했습니다.

### 결론
기존에는 DB 락 기반 처리나 Redis를 활용한 큐잉 방식으로 동시성 문제를 해결하려 했지만,
성능 저하, 관리 비용, 메시지 유실 등의 한계가 있었습니다.<br>
Kafka는 다음과 같은 장점을 통해 이러한 문제들을 효과적으로 해결할 수 있습니다
- 쿠폰 ID별 병렬 처리로 불필요한 대기 시간 해소
- 컨슈머 확장성을 통해 DB 부하 제어 및 안정성 확보
- 디스크 기반 저장과 재처리 기능으로 발급 실패 상황에도 유실 없는 복구 가능
- Redis 사용 최소화로 운영 복잡도 감소

이러한 이유로 `Kafka 기반 구조로 전환`하였습니다.

# 3. TO-BE - Redis + Kafka
![쿠폰발급설계_카프카.png](/docs/image/쿠폰발급설계_카프카.png)

## 선작업
- Redis에는 발급 가능한 쿠폰의 ID 목록을 저장한다. 
- 따라서 쿠폰 등록 시, 먼저 쿠폰 정보를 DB에 저장한 뒤 해당 쿠폰의 ID를 Redis에 추가하는 선행 작업이 필요하다

## 본 작업
> 쿠폰의 재고가 없는 경우 API 요청 흐름을 사전에 차단하기 위해, 
> 요청된 쿠폰 ID가 Redis에 존재할 때만 발급을 진행하고, 존재하지 않을 경우 발급을 차단한다.

1. 쿠폰 발급 요청 시, Redis에서 발급 가능한 쿠폰 id인지 확인한다
2. 발급 가능한 쿠폰 ID인 경우, 해당 쿠폰 ID를 Key로 하여 couponId와 userId를 포함한 정보를 Value로 구성해 Kafka Producer를 통해 브로커에 전송한다
   - 쿠폰 발급 토픽에서는 쿠폰 ID를 기준으로 파티션을 분산하여, 쿠폰 ID별로 병렬 처리가 가능하도록 구성한다
3. 카프카 컨슈머는 쿠폰 발급 서비스를 호출하여, 해당 쿠폰을 발급하고 쿠폰 재고를 차감한 뒤, 발급 내역을 저장한다
   - 쿠폰 발급 시, 쿠폰의 재고가 0이면 RuntimeException이 발생하여, Redis에 저장된 발급 가능한 쿠폰 ID 목록에서 해당 쿠폰 ID를 제거한다
   - 위 작업 이후 동일한 쿠폰 ID로 발급 요청이 들어오면, 해당 쿠폰 ID가 Redis의 '발급 가능한 쿠폰 ID 목록'에 존재하지 않기 때문에 발급이 진행되지 않는다