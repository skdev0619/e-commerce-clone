# 쿠폰 발급 고도화

## 1. AS-IS
![as-is쿠폰발급.png](/docs/image/as-is쿠폰발급.png)
> 멀티 스레드 환경에서 쿠폰 발급하면 쿠폰 재고에 대한 동시성 이슈가 발생할 수 있기 때문에<br>
> 쿠폰의 식별자(coupon_id)에 분산락을 걸고 쿠폰을 발급하도록 설계하였다.

## 2. 고민
### 문제 상황
- 동시성 이슈는 해결했지만, **분산 락 사용으로 인해 전체 처리량이 저하되는 문제**가 발생하였다

### 해결 방안: 큐 기반 처리 방식 도입
- **쿠폰 발급 요청을 큐에 줄세워 처리하는 방식**을 도입하였다
- 클라이언트의 쿠폰 발급 요청은 **Producer**가 Redis 또는 메시지 큐에 저장한다
- 백그라운드에서 별도로 실행되는 **Consumer**가 순차적으로 해당 요청을 처리하는 구조이다

### 기대 효과
- 락 사용하지 않고 **안정적인 동시성 제어**가 가능하다
- 처리량 개선 및 시스템 부하 감소**를 기대할 수 있다

## 3. TO-BE
![to-be쿠폰발급.png](/docs/image/to-be쿠폰발급.png)

> `쿠폰의 요청을 받는 곳(Producer)와 쿠폰 발급을 처리(Consumer)를 분리하고 Consumer가 비동기로 실행되도록 변경하였다`

### Producer
사용자가 쿠폰 발급을 요청하면, 해당 쿠폰 ID와 요청한 사용자 ID를 Redis에 저장한다

### Consumer
1분 주기로 스케줄러가 실행되며, 다음과 같은 작업을 수행한다
1. Redis에서 발급 요청이 등록된 쿠폰 ID 목록을 조회한다
2. 조회된 쿠폰 ID 목록을 순회하며 각 쿠폰에 대해 다음을 처리한다
   - 해당 쿠폰의 재고 수량을 조회한다
   - 재고 수량만큼 발급 요청 유저 ID 목록을 조회하고 제거(pop) 한다
   - 조회된 유저 ID 목록을 대상으로 쿠폰 발급을 수행한다
   - 쿠폰 발급이 완료되면, Redis에서 해당 쿠폰 ID 및 유저 ID 목록을 제거한다