# 동시성 이슈 대응 보고서

## 1. 문제 발생 배경

> 웹 어플리케이션의 경우 운영 환경에서는 다수의 사용자 요청이 동시에 유입되고, 실제 서비스는 멀티 스레드 환경에서 동작합니다.
> 특히, Spring 기반의 웹 애플리케이션은 요청마다 별도의 스레드가 할당되어 처리되므로, **같은 시점에 동일 자원에 접근하는 경합 상황(Race Condition)**이 발생할 수 있습니다.
> 이러한 동시성 문제를 사전에 식별하고, 적절한 동시성 제어 기법을 적용하여 안정적으로 서비스를 운영하고자 합니다.

## 2. 문제 정의

### Lost Update 란?

두 개 이상의 요청이 동일 자원을 읽고 수정하는 과정에서, 한 쪽의 수정 결과가 덮어씌워져 사라지는 현상

---

### Lost Update 과 데이터 정합성

다수의 사용자 요청이 동시에 처리될 때, 공유 자원에 대한 갱신 작업이 겹쳐서 `Lost Update` 문제가 발생할 수 있습니다.<br>
정합성 있는 데이터 처리를 보장하기 위해서는 `Lost Update 발생 가능성을 인지`하고, 이에 대한 적절한 동시성 제어 기법이 반드시 필요합니다.

## 3. 문제 대상

### 1) **상품 재고 차감**
다수의 사용자가 동시에 동일한 상품을 구매하는 경우, 재고 차감 과정에서 한 트랜잭션의 업데이트가 다른 트랜잭션의 업데이트를 덮어씌우는 문제가 발생할 수 있습니다
### 2) **쿠폰 발급**
동일한 쿠폰이 동시에 발급될 경우, 쿠폰 재고 차감 과정에서 트랜잭션 간 충돌로 인해 하나의 업데이트가 다른 업데이트를 덮어쓰는 문제가 발생할 수 있습니다
### 3) **잔액 충전 / 잔액 차감**
여러 사용자가 동시에 잔액을 갱신할 경우, 트랜잭션 간의 충돌로 인해 한 사용자의 잔액 변경 내역이 다른 트랜잭션에 의해 덮어씌워질 수 있습니다

## 4. 해결 방안 및 적용 내역

여러 동기화 기법 중 db 락을 사용하기로 하였으며 db의 비관적락과 낙관적 락을 사용하여 동시성 제어 처리를 하기로 하였습니다.

### 상품 재고 차감 / 쿠폰 발급 
#### 1) 처리가 될 경우 무엇이 효율적인가?
- 인기 상품/쿠폰의 경우 충돌이 많이 생길 수 있습니다
- 비관적 락을 이용하여 처리할 경우
  - row 잠금으로 인한 지연은 생기지만 db 타임아웃 시간 내에만 실행된다면 처리는 반드시 보장됩니다
- 낙관적 락을 이용하여 처리할 경우
  - 재시도 : 상품/쿠폰의 재고와 동시 요청자 수에 따라 재시도 횟수를 어떻게 설정할지 모호합니다
  - 사용자 재요청 유도 : 인기 상품/쿠폰의 경우, 충돌이 많으므로 잦은 재요청 유도가 발생하며 이는 부정적인 사용자 경험을 발생시킵니다

#### 2) 충돌이 많이 일어나는가?
- 인기 상품/쿠폰의 경우, 충돌이 많이 발생할 수 있습니다
- 특히 낙관적 락의 경우, 충돌이 많아지면 많은 재시도 요청이 발생하며 db 연결 수 급증으로 인해 커넥션 풀에 부하를 발생시킵니다

#### 3) 데이터 정합성이 중요한가?
- 재고 성격의 데이터는 정합성이 중요합니다
- 충돌이 많은 상황에서 `데이터 정합성이 중요한 경우, 비관적 락이 적절`합니다

> 결론 : 비관적 락 적용
---

### 잔액 충전 / 잔액 차감
#### 1) 처리가 될 경우 무엇이 효율적인가?
- 잔액 갱신의 경우, 충돌이 거의 발생하지 않습니다
- 비관적 락을 이용하여 처리할 경우, 충돌이 거의 없는 경우는 row 잠금으로 인한 지연으로 인해 낙관적 락보다 성능이 안좋을 가능성이 높습니다

#### 2) 충돌이 많이 일어나는가?
- 잔액 갱신에 대한 충돌은 거의 발생하지 않습니다
- 오히려 이런 경우를 어뷰징이라 판단하고 사용자가 재시도 요청하는 방향으로 선택하였습니다
  - 이런 상황 자체가 거의 발생하지 않으므로 부정적인 사용자 경험은 쌓이지 않는다고 판단하였습니다

#### 3) 데이터 정합성이 중요한가?
- 금액 성격의 데이터는 정합성이 중요합니다
- 충돌이 드물기 때문에 낙관적 락을 적용하고 충돌 시 사용자에게 재시도를 유도하는 방식으로도 데이터 정합성을 유지할 수 있습니다

#### 결론
> 낙관적 락 적용 / 재시도 없음