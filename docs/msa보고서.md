# MSA 설계 문서

## 1. 개요

> 이커머스 시스템은 주문, 결제, 상품, 쿠폰 등 여러 도메인이 복잡하게 연동됩니다<br>
> 기존 모놀리식 구조에서는 여러 도메인의 작업이 하나의 긴 트랜잭션으로 처리되는 경우가 많았습니다<br>
> 그러나 긴 트랜잭션으로 인한 문제를 해결하기 위해, 각 도메인이 자체 트랜잭션 범위를 갖고 독립적으로 동작하는 MSA 구조를 도입하기로 하였습니다

## 2. 배포 단위 분리

| 도메인         | 주요 기능                | 직접 의존하는 도메인              |
|-------------|----------------------|--------------------------|
| **User**    | 사용자 등록, 수정, 조회       | 없음                       |
| **Point**   | 포인트 적립, 차감, 이력 조회    | ✅ Order 요청에 의해 포인트 차감    | 
| **Product** | 상품 등록, 수정, 조회, 재고 차감 | ✅ Order 요청에 의해 상품 재고 차감  | 
| **Coupon**  | 쿠폰 발급, 조회, 사용        | ✅ Order 요청에 의해 쿠폰 사용     | 
| **Order**   | 주문 요청 처리             | ✅ Product, Coupon, Point | 
| **Payment** | 결제 요청, 승인, 취소        | ✅ Order로부터 주문 금액 참조      |
 
## 3. 도메인 간 의존성 줄이기

> Order 도메인은 Product, Coupon, Payment, Point 도메인에 요청을 보내 처리 흐름을 이어가기 때문에, <br>
> 해당 도메인들에 대한 의존성을 갖습니다.<br><br>
> 하지만 주문 도메인이 다른 도메인을 직접 호출하는 대신, <br>
> 이벤트 기반의 사가 코레오그래피 패턴을 부분적으로 적용하여 각 도메인 간 느슨한 결합을 유지하도록 설계하였습니다.<br><br>
> 이와 같이 이벤트 기반 방식을 부분 적용하여 도메인 간 결합도를 낮추고, 각 도메인이 독립적인 트랜잭션 범위를 가지도록 하였으나,  <br>
> 독립된 도메인의 트랜잭션 특성상 장애나 실패 발생 시 데이터 정합성을 위해 보상 트랜잭션을 직접 구현해야 한다는 한계가 존재합니다<br>

# 4. MSA 주문의 흐름

## 1) 주문 정상 처리의 경우

![주문msa해피케이스.png](/docs/image/주문msa해피케이스.png)

### 재고 차감을 **동기 처리** 하는 이유

1. 부정적인 사용자 경험 방지

- 재고 차감과 결제를 비동기로 처리할 경우, 결제가 완료된 후 재고 부족으로 인해 주문이 실패할 가능성이 존재한다
- 사용자는 결제는 성공했지만 주문이 실패했다는 불편한 경험을 겪게 된다

이러한 문제를 방지하기 위해 `먼저 재고를 확인하고 차감한 후, 결제를 진행`하기로 결정하였다

2. 재고 부족을 사용자에게 즉시 알림

- 주문 시점에 재고가 부족한 경우, 결제 이전에 바로 실패 응답을 줄 수 있어 `불필요한 결제 진행을 방지`할 수 있다
- 결제 네트워크 비용을 절감할 수 있으며, 특히 PG 사용한다면 PG 이용 수수료의 비용 부담을 줄일 수 있다

## 2) (동기 처리)상품 재고 부족

![주문msa재고부족.png](/docs/image/주문msa재고부족.png)

- 재고가 부족한 경우, Payment, Coupon 요청을 생략하고 주문 흐름을 조기 차단할 수 있다

## 3) (비동기 처리) 잔액 부족, 유효하지 않은 쿠폰

![msa주문edge케이스.png](/docs/image/msa주문edge케이스.png)

## 5. 추가 보완 사항

### 1) 보상 트랜잭션에서의 데이터 정합성 문제

#### 문제 상황

>1. 주문이 접수되어 결제 요청한다
>2. 잔액 부족으로 인하여 결제를 못하고 주문 취소 이벤트가 발행된다
>3. `결제가 실제로 수행되지 않았지만`, 주문 취소 이벤트를 수신한 결제가 잔액을 복원한다
>4. 그 결과, 잔액이 늘어나는 문제 발생

즉, 보상 트랜잭션이 실행하기전에 `작업이 성공 여부에 대한 명확한 상태 확인이 부족한 경우` 데이터 정합성에 문제가 생길 수 있다

#### 해결 방향

보상 트랜잭션은 실행 전에 `해당 작업이 실제로 성공했는지를 확인한 후에만 수행`되어야 한다